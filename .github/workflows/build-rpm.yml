name: Build RPM
on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install build deps
        run: dnf install -y rpm-build python3 gettext
      - name: Build RPM
        run: |
          set -e
          VER=$(grep -oP 'version = "\K[^"]+' pyproject.toml | head -1)
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,RPMS}
          tar czf ~/rpmbuild/SOURCES/debian-installer-companion-${VER}.tar.gz --transform "s,^,debian-installer-companion/," -C $(pwd)/.. debian-installer-companion/
          echo "TmFtZTogICAgICAgICAgIGRlYmlhbi1pbnN0YWxsZXItY29tcGFuaW9uClZlcnNpb246ICAgICAgICBWRVJTSU9OUExBQ0VIT0xERVIKUmVsZWFzZTogICAgICAgIDEKU3VtbWFyeTogICAgICAgIEdUSzQgYXBwIC0gZGViaWFuLWluc3RhbGxlci1jb21wYW5pb24KTGljZW5zZTogICAgICAgIEdQTC0zLjAtb3ItbGF0ZXIKVVJMOiAgICAgICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS95ZWFnZXIvZGViaWFuLWluc3RhbGxlci1jb21wYW5pb24KU291cmNlMDogICAgICAgICV7bmFtZX0tJXt2ZXJzaW9ufS50YXIuZ3oKQnVpbGRBcmNoOiAgICAgIG5vYXJjaApSZXF1aXJlczogICAgICAgcHl0aG9uMywgcHl0aG9uMy1nb2JqZWN0LCBndGs0LCBsaWJhZHdhaXRhCgolZGVzY3JpcHRpb24KR1RLNC9BZHdhaXRhIGFwcGxpY2F0aW9uIGZyb20gRGFubmUgTDEwbiBBcHAgU3VpdGUuCgolcHJlcAolc2V0dXAgLXEgLW4gJXtuYW1lfQoKJWluc3RhbGwKbWtkaXIgLXAgJFJQTV9CVUlMRF9ST09UL3Vzci9iaW4KbWtkaXIgLXAgJFJQTV9CVUlMRF9ST09UL3Vzci9saWIvcHl0aG9uMy9kaXN0LXBhY2thZ2VzL2RlYmlhbl9pbnN0YWxsZXJfY29tcGFuaW9uCm1rZGlyIC1wICRSUE1fQlVJTERfUk9PVC91c3Ivc2hhcmUvYXBwbGljYXRpb25zCmNwIHNyYy9kZWJpYW5faW5zdGFsbGVyX2NvbXBhbmlvbi8qLnB5ICRSUE1fQlVJTERfUk9PVC91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy9kZWJpYW5faW5zdGFsbGVyX2NvbXBhbmlvbi8KcHJpbnRmICcjIS91c3IvYmluL2VudiBweXRob24zXG5mcm9tIGRlYmlhbl9pbnN0YWxsZXJfY29tcGFuaW9uLm1haW4gaW1wb3J0IG1haW5cbm1haW4oKVxuJyA+ICRSUE1fQlVJTERfUk9PVC91c3IvYmluL2RlYmlhbi1pbnN0YWxsZXItY29tcGFuaW9uCmNobW9kICt4ICRSUE1fQlVJTERfUk9PVC91c3IvYmluL2RlYmlhbi1pbnN0YWxsZXItY29tcGFuaW9uCmlmIFsgLWYgZGViaWFuLWluc3RhbGxlci1jb21wYW5pb24uZGVza3RvcCBdOyB0aGVuIGNwIGRlYmlhbi1pbnN0YWxsZXItY29tcGFuaW9uLmRlc2t0b3AgJFJQTV9CVUlMRF9ST09UL3Vzci9zaGFyZS9hcHBsaWNhdGlvbnMvOyBmaQoKJWZpbGVzCi91c3IvYmluL2RlYmlhbi1pbnN0YWxsZXItY29tcGFuaW9uCi91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy9kZWJpYW5faW5zdGFsbGVyX2NvbXBhbmlvbi8KL3Vzci9zaGFyZS9hcHBsaWNhdGlvbnMvKi5kZXNrdG9wCg==" | base64 -d | sed "s/VERSIONPLACEHOLDER/${VER}/g" > ~/rpmbuild/SPECS/debian-installer-companion.spec
          rpmbuild -bb ~/rpmbuild/SPECS/debian-installer-companion.spec
      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/**/*.rpm
